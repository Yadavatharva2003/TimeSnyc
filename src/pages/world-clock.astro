---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import AdSlot from "../components/AdSlot.astro";
---
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>World Clock â€” TimeSync</title>

  <link rel="stylesheet" href="/styles/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    /* =========================
       LAYOUT
    ========================= */
    .layout {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .left-panel {
      flex: 1;
      min-width: 300px;
    }

    .right-panel {
      flex: 2;
    }

    .clock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    /* =========================
       DRAG + ROW
    ========================= */
    .clock-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .drag-handle {
      width: 28px;
      background: #f3f4f6;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      user-select: none;
      color: #555;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    /* =========================
       TOOL CARD
    ========================= */
    .tool-card {
      position: relative;
      flex: 1;
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      box-shadow:
        0 1px 2px rgba(0,0,0,0.06),
        0 6px 16px rgba(0,0,0,0.06);
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .tool-card:hover {
      transform: translateY(-1px);
      box-shadow:
        0 6px 20px rgba(0,0,0,0.08);
    }

    .tool-card h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    /* Delete */
    .delete-clock {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
      opacity: 0.6;
    }

    .delete-clock:hover {
      opacity: 1;
      color: #e11d48;
    }

    /* =========================
       ANALOG CLOCK
    ========================= */
    .analog-clock {
      position: relative;
      width: 110px;
      height: 110px;
      border: 4px solid #222;
      border-radius: 50%;
      margin: 10px auto;
      background: #fff;
    }

    .hand {
      position: absolute;
      bottom: 50%;
      left: 50%;
      transform-origin: bottom center;
      transform: translateX(-50%) rotate(0deg);
      border-radius: 3px;
    }

    .hand.hour { width: 6px; height: 32px; background: #222; }
    .hand.minute { width: 4px; height: 44px; background: #444; }
    .hand.second { width: 2px; height: 48px; background: #e11d48; }

    .center-dot {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #222;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* =========================
       TEXT INFO
    ========================= */
    .clock-time {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .clock-meta {
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.65;
    }

    .daylight-info {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 6px;
      font-size: 0.75rem;
      opacity: 0.75;
    }

    /* =========================
       SEARCH SUGGESTIONS
    ========================= */
    .suggest-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      z-index: 1000;
    }

    .ta-item {
      padding: 8px 10px;
      cursor: pointer;
    }

    .ta-item:hover {
      background: #f3f4f6;
    }
  </style>
</head>

<body>
  <Header />

  <main class="container">
    <section class="hero">
      <h1>World Clock</h1>
      <p>Track time across the world with precision.</p>
    </section>

    <section class="section">
      <div class="layout">

        <!-- LEFT PANEL -->
        <div class="left-panel">
          <div style="position:relative">
            <input id="search" class="input" placeholder="Search countryâ€¦" />
            <div id="suggest" class="suggest-list" style="display:none"></div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button id="addBtn" class="button">Add Clock</button>
            <button id="locateBtn" class="button">Use My Location</button>
            <button id="clearBtn" class="button ghost">Clear</button>
          </div>

          <!-- ADS (OUTSIDE TOOL CARDS) -->
          <div style="margin-top:28px">
            <AdSlot slot="1234567890" />
          </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel">
          <div id="clocks" class="clock-grid"></div>
        </div>

      </div>
    </section>

    <section class="section">
      <h2>Map</h2>
      <div id="map" style="height:360px;border-radius:12px"></div>
    </section>
  </main>

  <Footer />

  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <script type="module">
    import { getUserGeoTimezone } from "/scripts/geo-timezone.js";

    document.addEventListener("DOMContentLoaded", async () => {

      let countries = [];
      let clocks = [];
      let map, markers = [];
      let draggedId = null;

      const KEY = "timesync_world_clocks_final";

      const clocksEl = document.getElementById("clocks");
      const search = document.getElementById("search");
      const suggest = document.getElementById("suggest");
      const addBtn = document.getElementById("addBtn");
      const locateBtn = document.getElementById("locateBtn");
      const clearBtn = document.getElementById("clearBtn");

      async function loadCountries() {
        if (countries.length) return;
        const res = await fetch("/data/countries.json");
        const raw = await res.json();
        countries = raw
          .filter(c => c.n && c.t?.length)
          .map(c => ({
            name: c.n,
            lat: c.la,
            lon: c.lo,
            timezones: c.t
          }))
          .sort((a,b)=>a.name.localeCompare(b.name));
      }

      async function initMap() {
        await new Promise(r => {
          const s = document.createElement("script");
          s.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
          s.onload = r;
          document.body.appendChild(s);
        });
        map = L.map("map").setView([20, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
      }

      function render() {
        clocksEl.innerHTML = "";

        clocks.forEach(c => {
          const row = document.createElement("div");
          row.className = "clock-row";
          row.id = c.id;

          const handle = document.createElement("div");
          handle.className = "drag-handle";
          handle.textContent = "â˜°";
          handle.draggable = true;

          const card = document.createElement("div");
          card.className = "tool-card";

          card.innerHTML = `
            <button class="delete-clock">âœ•</button>
            <h3>${c.label}</h3>

            <div class="analog-clock">
              <div class="hand hour"></div>
              <div class="hand minute"></div>
              <div class="hand second"></div>
              <div class="center-dot"></div>
            </div>

            <div class="clock-time"></div>
            <div class="clock-meta">${c.tz}</div>

            <div class="daylight-info">
              ðŸŒ… <span class="sunrise"></span>
              ðŸŒ‡ <span class="sunset"></span>
            </div>
          `;

          card.querySelector(".delete-clock").onclick = () => {
            clocks = clocks.filter(x => x.id !== c.id);
            save();
            render();
          };

          handle.addEventListener("dragstart", () => draggedId = c.id);
          row.addEventListener("dragover", e => e.preventDefault());
          row.addEventListener("drop", () => reorder(draggedId, c.id));

          row.appendChild(handle);
          row.appendChild(card);
          clocksEl.appendChild(row);
        });
      }

      function reorder(fromId, toId) {
        if (!fromId || fromId === toId) return;
        const a = clocks.findIndex(c => c.id === fromId);
        const b = clocks.findIndex(c => c.id === toId);
        const [m] = clocks.splice(a,1);
        clocks.splice(b,0,m);
        save();
        render();
      }

      function updateClocks() {
        const now = new Date();
        clocks.forEach(c => {
          const el = document.getElementById(c.id);
          if (!el) return;

          const local = new Date(now.toLocaleString("en-US", { timeZone: c.tz }));
          const h = local.getHours() % 12;
          const m = local.getMinutes();
          const s = local.getSeconds();

          el.querySelector(".clock-time").textContent = local.toTimeString().slice(0,8);
          el.querySelector(".hand.hour").style.transform = `translateX(-50%) rotate(${h*30 + m*0.5}deg)`;
          el.querySelector(".hand.minute").style.transform = `translateX(-50%) rotate(${m*6 + s*0.1}deg)`;
          el.querySelector(".hand.second").style.transform = `translateX(-50%) rotate(${s*6}deg)`;

          const t = SunCalc.getTimes(new Date(), c.lat, c.lon);
          el.querySelector(".sunrise").textContent = t.sunrise?.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}) ?? "--";
          el.querySelector(".sunset").textContent = t.sunset?.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}) ?? "--";
        });
      }

      function save(){ localStorage.setItem(KEY, JSON.stringify(clocks)); }
      function load(){ clocks = JSON.parse(localStorage.getItem(KEY) || "[]"); }

      addBtn.onclick = async () => {
        await loadCountries();
        const q = search.value.toLowerCase();
        const c = countries.find(x => x.name.toLowerCase().includes(q));
        if (c) clocks.unshift({ id: crypto.randomUUID(), label:c.name, tz:c.timezones[0], lat:c.lat, lon:c.lon });
        save(); render();
      };

      locateBtn.onclick = async () => {
        const d = await getUserGeoTimezone();
        clocks.unshift({ id: crypto.randomUUID(), label:"My Location", tz:d.timezone, lat:d.lat, lon:d.lon });
        save(); render();
      };

      clearBtn.onclick = () => {
        clocks = [];
        save();
        render();
      };

      await loadCountries();
      load();
      await initMap();
      render();
      setInterval(updateClocks, 1000);
    });
  </script>
</body>
</html>
