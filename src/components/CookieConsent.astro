---
/*
  CookieSettings.astro
  Full cookie settings modal with toggles for Ads / Analytics / Marketing.
  Persists to localStorage key: timesync_cookie_pref_v1
  Exposes window.openCookieSettings() to open modal.
*/
---
<html:fragment>
  <div id="cookie-settings-modal" class="cookie-settings-modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none">
    <div class="cookie-settings-card" role="document">
      <button id="cs-close" class="cs-close" aria-label="Close cookie settings">âœ•</button>
      <h2 class="cs-title">Cookie Settings</h2>
      <p class="cs-desc">Choose which cookies you'd like to allow. Essential cookies are required for the site to function.</p>

      <form id="cs-form" class="cs-form" onsubmit="event.preventDefault();">
        <div class="cs-row">
          <div class="cs-left">
            <strong>Essential</strong>
            <div class="cs-sub">Required for site functionality</div>
          </div>
          <div class="cs-right">
            <label class="cs-toggle disabled">
              <input type="checkbox" checked disabled aria-hidden="true"/>
              <span>On</span>
            </label>
          </div>
        </div>

        <div class="cs-row">
          <div class="cs-left">
            <strong>Ads</strong>
            <div class="cs-sub">Personalized ads to support TimeSync (can be toggled)</div>
          </div>
          <div class="cs-right">
            <label class="cs-toggle">
              <input id="cs-ads" type="checkbox" />
              <span class="toggle-label">Off</span>
            </label>
          </div>
        </div>

        <div class="cs-row">
          <div class="cs-left">
            <strong>Analytics</strong>
            <div class="cs-sub">Usage analytics to improve the site (anonymous)</div>
          </div>
          <div class="cs-right">
            <label class="cs-toggle">
              <input id="cs-analytics" type="checkbox" />
              <span class="toggle-label">Off</span>
            </label>
          </div>
        </div>

        <div class="cs-row">
          <div class="cs-left">
            <strong>Marketing</strong>
            <div class="cs-sub">Marketing and retargeting cookies</div>
          </div>
          <div class="cs-right">
            <label class="cs-toggle">
              <input id="cs-marketing" type="checkbox" />
              <span class="toggle-label">Off</span>
            </label>
          </div>
        </div>

        <div class="cs-actions">
          <button id="cs-reject-all" class="cs-btn ghost">Reject All</button>
          <button id="cs-accept-all" class="cs-btn primary">Accept All</button>
          <button id="cs-save" class="cs-btn">Save</button>
        </div>

        <div style="margin-top:8px;font-size:12px;color:#666">
          You can change these at any time via <em>Manage Cookies</em>.
        </div>
      </form>
    </div>
  </div>

  <style>
    /* basic, self-contained styles */
    .cookie-settings-modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:150; background:rgba(0,0,0,0.22); }
    .cookie-settings-card{ width: min(680px, 92vw); background: rgba(255,255,255,0.92); backdrop-filter: blur(6px); border-radius:12px; padding:18px; box-shadow:0 18px 40px rgba(0,0,0,0.12); position:relative; }
    .cs-close{ position:absolute; right:12px; top:10px; border:none; background:none; font-size:18px; cursor:pointer }
    .cs-title{ margin:0 0 6px 0; font-size:18px; }
    .cs-desc{ margin:0 0 12px 0; color:#666; font-size:13px }
    .cs-form{ display:flex; flex-direction:column; gap:12px }
    .cs-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 6px; border-radius:8px }
    .cs-row:hover{ background:rgba(0,0,0,0.02) }
    .cs-left{ max-width:70% }
    .cs-sub{ font-size:13px; color:#6b6b6b }
    .cs-right{ min-width:120px; text-align:right }
    .cs-toggle{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none }
    .cs-toggle.disabled{ opacity:0.6; cursor:default }
    .cs-toggle input{ width:28px; height:18px; position:relative }
    .toggle-label{ font-size:13px; color:#444; min-width:34px; display:inline-block; text-align:left }
    .cs-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:6px }
    .cs-btn{ padding:8px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:#fff; cursor:pointer; font-weight:700 }
    .cs-btn.primary{ background:#0b74ff; color:white; border-color:transparent }
    .cs-btn.ghost{ background:transparent; border-color:transparent; color:#666 }
    @media (max-width:520px){ .cookie-settings-card{ padding:12px } .cs-right{ min-width:86px } }
  </style>

  <script type="module">
    // Cookie settings module
    const KEY = 'timesync_cookie_pref_v1';

    function safeParse(v){ try{ return JSON.parse(v); }catch(e){ return null; } }
    function getPref(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return null;
        const parsed = safeParse(raw);
        if(parsed && (parsed.ads === true || parsed.ads === false)) return parsed;
        return null;
      }catch(e){ return null; }
    }
    function setPref(obj){
      try{ localStorage.setItem(KEY, JSON.stringify(obj)); }catch(e){}
    }

    // UI refs
    const modal = document.getElementById('cookie-settings-modal');
    const closeBtn = document.getElementById('cs-close');
    const adsInput = document.getElementById('cs-ads');
    const analyticsInput = document.getElementById('cs-analytics');
    const marketingInput = document.getElementById('cs-marketing');
    const saveBtn = document.getElementById('cs-save');
    const acceptAllBtn = document.getElementById('cs-accept-all');
    const rejectAllBtn = document.getElementById('cs-reject-all');

    function applyTogglesToUI(pref){
      if(!pref) { adsInput.checked = false; analyticsInput.checked = false; marketingInput.checked = false; return; }
      adsInput.checked = Boolean(pref.ads);
      analyticsInput.checked = Boolean(pref.analytics);
      marketingInput.checked = Boolean(pref.marketing);
      updateToggleLabels();
    }

    function updateToggleLabels(){
      document.querySelectorAll('.cs-toggle input').forEach(inp=>{
        const lbl = inp.nextElementSibling;
        if(lbl) lbl.textContent = inp.checked ? 'On' : 'Off';
      });
    }

    // Callbacks to wire third-party features (safe no-op if functions missing)
    function enableAds(){
      if(window.__timesyncAcceptAds) window.__timesyncAcceptAds();
      if(window.__timesync && typeof window.__timesync.loadAdsNow === 'function') window.__timesync.loadAdsNow();
    }
    function disableAds(){ /* best-effort: you may want to remove ad iframes or block loaders */ }

    function enableAnalytics(){
      if(window.__timesyncEnableAnalytics) try{ window.__timesyncEnableAnalytics(); }catch(e){}
      // you can add other analytics init hooks here
    }
    function disableAnalytics(){ /* optional: disable analytics cookies if possible */ }

    function enableMarketing(){ /* optional: init pixels */ }
    function disableMarketing(){ /* optional */ }

    // Open/close modal
    function openModal(){
      const current = getPref();
      applyTogglesToUI(current);
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    // Public API
    window.openCookieSettings = openModal;

    // Save handler
    function saveSettings(){
      const obj = {
        ads: Boolean(adsInput.checked),
        analytics: Boolean(analyticsInput.checked),
        marketing: Boolean(marketingInput.checked),
        ts: Date.now()
      };
      setPref(obj);
      // execute side-effects
      if(obj.ads) enableAds(); else disableAds();
      if(obj.analytics) enableAnalytics(); else disableAnalytics();
      if(obj.marketing) enableMarketing(); else disableMarketing();

      // dispatch event for other listeners
      window.dispatchEvent(new CustomEvent('timesync:consent', { detail: obj }));
      closeModal();
    }

    // Accept all / Reject all
    function acceptAll(){
      adsInput.checked = true; analyticsInput.checked = true; marketingInput.checked = true;
      updateToggleLabels(); saveSettings();
    }
    function rejectAll(){
      adsInput.checked = false; analyticsInput.checked = false; marketingInput.checked = false;
      updateToggleLabels(); saveSettings();
    }

    // Wire events
    document.addEventListener('DOMContentLoaded', ()=>{
      // initial hide
      modal.style.display = 'none';
      updateToggleLabels();

      closeBtn.addEventListener('click', closeModal);
      saveBtn.addEventListener('click', saveSettings);
      acceptAllBtn.addEventListener('click', acceptAll);
      rejectAllBtn.addEventListener('click', rejectAll);

      // clicking the backdrop closes
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

      // toggles -> update label text
      document.querySelectorAll('.cs-toggle input').forEach(inp => {
        inp.addEventListener('change', updateToggleLabels);
      });

      // ensure initial values reflect stored pref (so when user opens it matches their stored pref)
      const p = getPref();
      if(p) applyTogglesToUI(p);
    });

    // expose reset for dev
    window.__timesync_cookie = window.__timesync_cookie || {};
    window.__timesync_cookie.resetSettings = function(){
      try{ localStorage.removeItem(KEY); }catch(e){}
      // Also show the cookie consent banner again if present
      const banner = document.getElementById('ts-consent');
      if(banner){ banner.style.display = 'flex'; banner.setAttribute('aria-hidden','false'); }
    };

    // keyboard: Esc closes modal
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });
  </script>
</html:fragment>
